目的:
- ユーザー視点の自動E2E/回帰テスト基盤を C:\AI\KowareyukuJapan に構築。
- Codex CLI から Playwright MCP / Browser MCP / Browserbase MCP を道具として呼べるようにする。
- Replay.io で失敗時の決定論的録画、レポート自動生成、夜間回帰のスケジュール実行。
- 破壊操作は保留、他は非対話で自動化。

前提:
- OS: Windows
- パッケージ管理: pnpm または npm
- Node 18+ / Python 3.11+ / Git 有り

手順:
1) 依存導入とPlaywright初期化
- 端末で以下を順に実行:
  - if (Test-Path package.json) { Write-Host "ok" } else { npm init -y }
  - npm i -D @playwright/test @types/node
  - npx playwright install --with-deps chromium
  - npm i -D start-server-and-test dotenv

2) テスト構成の雛形を生成
- 作成/編集:
  - playwright.config.ts:
    - projects: chromium(headed:false), mobileChrome(viewport相当), slowMo: 0
    - use: { baseURL: "http://localhost:3000", storageState: "storage-state.json", trace: "on-first-retry", video: "retain-on-failure", screenshot: "only-on-failure" }
    - reporter: [["html",{open:"never"}],["junit",{outputFile:"reports/junit.xml"}]]
  - package.json scripts:
    - "dev": "next dev -p 3000"
    - "test:e2e": "playwright test"
    - "test:ui": "playwright test --ui"
    - "test:headed": "playwright test --headed"
    - "test:report": "playwright show-report"
    - "e2e:ci": "start-server-and-test dev http://localhost:3000 test:e2e"
    - "e2e:tag:@smoke": "playwright test -g @smoke"
  - tests/e2e/smoke.spec.ts:
    - 1) 初期描画のLCP要素可視性
    - 2) 主要ユーザーフロー(サインアップ/ログイン/検索/購入系はモックで)
    - 3) a11yロール/名前で操作 (getByRole, getByLabel)
    - 各itに @smoke タグ付与

3) MCP 連携 (Codexから使う)
- %USERPROFILE%\.codex\config.toml を作成/編集:
  - [mcp_servers.playwright]
    command = "npx"
    args = ["-y","playwright-mcp"]     # microsoft/playwright-mcp
  - [mcp_servers.browser]
    command = "npx"
    args = ["-y","browser-mcp"]        # Puppeteer系 Browser MCP
  - [mcp_servers.browserbase]
    command = "npx"
    args = ["-y","@browserbaseai/mcp-server-browserbase"]
    env = { BROWSERBASE_API_KEY = "${env:BROWSERBASE_API_KEY}" }
  - [tools.replay]
    command = "npx"
    args = ["-y","@replayio/playwright-test"]  # 失敗時の録画アダプタ

4) ユーザーテスト観点の自動生成ユーティリティ
- tests/helpers/user-journeys.ts を作成:
  - ペルソナ別の「目的→行動→期待結果」テンプレ生成関数
  - data-test-id優先でセレクタ解決。ロール/名前フォールバック。

5) 失敗時の録画(Replay.io)
- npm i -D @replayio/playwright
- playwright.config.ts の reporter に ["@replayio/playwright/reporter"] を追加
- CI実行時は REPLAY_API_KEY を使用。ローカルは任意。

6) CI/夜間ジョブと成果物
- .github/workflows/e2e.yml を作成:
  - Windows-latest で node/setup, pnpm i
  - webを起動 → playwright test
  - artifacts: playwright-report/, reports/junit.xml, replayリンク
- 夜間(毎日02:00 JST)に全回帰。プッシュ時は @smoke のみ。

7) Codex運用コマンド(非対話)
- 解析:  "codex exec \"summarize codebase; list high-risk flows for e2e; propose 5 tests with steps and selectors\""
- 生成:  "codex exec \"scaffold 5 e2e specs into tests/e2e based on summary; use getByRole first; annotate with @smoke where relevant\""
- 実行:  "codex exec \"npm run e2e:ci\""
- 修正:  "codex exec \"read failing traces & replay links; propose patch; apply to src/**; add regression test; run affected\""

8) ガードレール
- 削除・大規模置換は保留。diffを提示してから apply。
- 秘密情報は .env.* を除外して読み取り不可。

完了条件:
- npm run test:e2e が成功し、playwright-report/ が生成。
- 失敗時に Replay リンクがコンソール出力。
- Codex TUIのツール一覧に playwright / browser / browserbase MCP が表示。
使い方（最小コマンド）
設定反映
codex "apply the above plan step-by-step in this repo; do not delete files; ask before destructive changes"

生成と実行
codex exec "create 5 persona-based journeys; implement tests; run npm run e2e:ci; print report path and any replay links"

回帰だけ叩く
npm run e2e:ci && npm run test:report

注記
Playwright MCP はMCPサーバとしてLLMにブラウザ操作を提供。テキスト駆動で可用性が高い。
GitHub

Browser MCP はPuppeteer由来で軽量。Chrome依存の拡張が必要な場合に便利。
Awesome MCP Servers

Browserbase MCP はクラウドで並列実行やスクショを提供。重いE2Eの実行先に適する。
GitHub

Replay.io は決定論的録画で「再現できない」を排除。失敗共有と根因解析を短縮。
Replay

QA Wolf はPlaywright作成・保守の外部化に有効。必要に応じて導入。
QA Wolf

この構成で「長期管理」「自動整理」「コード把握」「自動修正」「ユーザーテスト自動化」が揃う。導入時に発生したログを貼れば、失敗点に合わせて最小修正の追加指示を返す。